# Claude Worker Orchestration - Complete System Overview

## üèóÔ∏è System Components

This system provides **two complementary approaches** for running Claude with automatic agent role detection:

| Component | Purpose | Use Case | Output |
|-----------|---------|----------|--------|
| **spawn-worker** | Background automation | Long-running tasks, parallel work | tmux sessions |
| **cclaude-rs** | Interactive development | Manual work, debugging, exploration | Current terminal |

## üéØ Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    User Request                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  Background  ‚îÇ    ‚îÇ Interactive  ‚îÇ
  ‚îÇ    Work?     ‚îÇ    ‚îÇ    Work?     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ spawn-worker    ‚îÇ ‚îÇ  cclaude-rs      ‚îÇ
  ‚îÇ (tmux + inject) ‚îÇ ‚îÇ  (direct spawn)  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                   ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ CCLAUDE_AGENT       ‚îÇ
            ‚îÇ (environment var)   ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ .claude/hooks/      ‚îÇ
            ‚îÇ session_start.py    ‚îÇ
            ‚îÇ (auto-detect agent) ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Component Details

### 1. spawn-worker (Background Automation)

**Location**: `src/bin/claude-inject.rs` (spawn-worker command)

**Purpose**: Create detached tmux sessions for background work

**Features**:
- ‚úÖ Automatic agent loading via `mcp__agenthub_http__call_agent()`
- ‚úÖ Worker registry tracking (`~/.claude-worker-registry.json`)
- ‚úÖ Message injection with tmux send-keys
- ‚úÖ Status monitoring and management
- ‚úÖ Runs with `--dangerously-skip-permissions`

**Example**:
```bash
./target/release/claude-inject spawn-worker \
    --name worker-coding-1 \
    --agent coding-agent \
    --dir /home/user/project \
    --task-id task-123 \
    --prompt "Implement user authentication"
```

**When to Use**:
- Long-running tasks (multi-hour work)
- Parallel execution (multiple workers at once)
- Fire-and-forget automation
- You don't need to watch the output live

### 2. cclaude-rs (Interactive Development)

**Location**: `src/bin/cclaude-rs.rs`

**Purpose**: Launch Claude in current terminal with automatic role detection

**Features**:
- ‚úÖ Sets `CCLAUDE_AGENT` environment variable
- ‚úÖ Hooks automatically detect agent type
- ‚úÖ Runs with `--dangerously-skip-permissions`
- ‚úÖ Simple command-line interface
- ‚úÖ Compatible with worker registry

**Example**:
```bash
./target/release/cclaude-rs --agent coding-agent "task_id: abc-123"
```

**When to Use**:
- Interactive development work
- Manual debugging and exploration
- Quick one-off tasks
- You want to see output live in current terminal
- Testing before creating background worker

### 3. Worker Registry System

**Location**: `src/worker_registry.rs`

**File**: `~/.claude-worker-registry.json`

**Purpose**: Track all active Claude workers with metadata

**Data Structure**:
```json
{
  "workers": {
    "worker-coding-1": {
      "name": "worker-coding-1",
      "agent_type": "coding-agent",
      "task_id": "task-123",
      "tmux_session": "worker-coding-1",
      "working_dir": "/home/user/project",
      "spawned_at": 1763244699,
      "status": "working",
      "messages_sent": 3
    }
  }
}
```

**Features**:
- Automatic registration on spawn
- Status tracking (starting, ready, working, idle, error, stopped)
- Message counter
- Task ID association
- Easy querying by agent type, status, or task ID

### 4. Hook Integration System

**Location**: `.claude/hooks/session_start.py`

**Environment Variable**: `CCLAUDE_AGENT`

**Detection Flow**:
```python
# Line 1538-1540 in session_start.py
cclaude_agent = os.getenv("CCLAUDE_AGENT")
if cclaude_agent:
    agent_name = cclaude_agent
```

**Benefits**:
- ‚úÖ No conversation history parsing needed
- ‚úÖ Instant agent detection
- ‚úÖ Consistent across all launchers
- ‚úÖ Works with both spawn-worker and cclaude-rs

## üìä Comparison Matrix

| Feature | spawn-worker | cclaude-rs | bash cclaude |
|---------|--------------|------------|--------------|
| **Agent Detection** | ‚úÖ MCP call + env var | ‚úÖ Env var only | ‚úÖ Env var only |
| **Background Mode** | ‚úÖ tmux detached | ‚ùå Current terminal | ‚ùå New terminal |
| **Registry Tracking** | ‚úÖ Automatic | ‚úÖ Compatible | ‚ùå No |
| **Message Injection** | ‚úÖ tmux send-keys | ‚ùå No | ‚ùå No |
| **Status Monitoring** | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| **Auto Permissions** | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| **Terminal Spawning** | ‚ùå No (uses tmux) | ‚ùå No | ‚úÖ Yes (wt.exe, gnome-terminal) |
| **Cross-Platform** | ‚úÖ Yes | ‚úÖ Yes | ‚ö†Ô∏è Limited |
| **Speed** | ‚ö° Fast (Rust) | ‚ö° Fast (Rust) | üêå Interpreted (Bash) |

## üéØ Decision Tree: Which Tool to Use?

```
Do you need to watch output live?
‚îú‚îÄ YES ‚Üí cclaude-rs (interactive)
‚îî‚îÄ NO ‚Üí spawn-worker (background)

Do you need to inject messages later?
‚îú‚îÄ YES ‚Üí spawn-worker (tmux injection)
‚îî‚îÄ NO ‚Üí cclaude-rs (simple launch)

Do you need to run multiple workers in parallel?
‚îú‚îÄ YES ‚Üí spawn-worker (multiple sessions)
‚îî‚îÄ NO ‚Üí cclaude-rs or spawn-worker

Do you need to track worker status?
‚îú‚îÄ YES ‚Üí spawn-worker (registry + status)
‚îî‚îÄ NO ‚Üí cclaude-rs (simple)

Do you need a new terminal window?
‚îú‚îÄ YES ‚Üí bash cclaude (.claude/bin/cclaude)
‚îî‚îÄ NO ‚Üí cclaude-rs or spawn-worker
```

## üöÄ Complete Workflow Examples

### Example 1: Parallel Background Workers

```bash
# Spawn coding worker
./target/release/claude-inject spawn-worker \
    --name auth-coder \
    --agent coding-agent \
    --task-id task-auth-impl \
    --prompt "Implement JWT authentication"

# Spawn test worker
./target/release/claude-inject spawn-worker \
    --name auth-tester \
    --agent test-orchestrator-agent \
    --task-id task-auth-test

# List all workers
./target/release/claude-inject list-workers

# Monitor coding worker
./target/release/claude-inject worker-status --name auth-coder

# Inject message when coding done
./target/release/claude-inject tmux-inject \
    --name auth-tester \
    --message "Coding complete! Run tests for auth.js"

# View live output
tmux attach -t auth-tester
```

### Example 2: Interactive Development

```bash
# Start interactive session
./target/release/cclaude-rs --agent coding-agent "Analyze authentication flow"

# Hooks automatically detect agent type
# Work interactively in current terminal
# Exit when done
```

### Example 3: Mixed Workflow

```bash
# 1. Start with interactive exploration
./target/release/cclaude-rs --agent system-architect-agent \
    "Design authentication architecture"

# 2. After design, spawn background workers
./target/release/claude-inject spawn-worker \
    --name impl-worker \
    --agent coding-agent \
    --task-id task-impl \
    --prompt "Implement authentication based on design"

# 3. Monitor worker progress
./target/release/claude-inject worker-status --name impl-worker

# 4. When blocked, inject guidance
./target/release/claude-inject tmux-inject \
    --name impl-worker \
    --message "Use JWT with 2-hour expiry"

# 5. Back to interactive for review
./target/release/cclaude-rs --agent code-reviewer-agent \
    "Review authentication implementation"
```

## üîß Installation & Setup

### 1. Build All Binaries

```bash
cd /home/daihu/__projects__/4genthub/claude-automation/rust-injector

# Build everything
cargo build --release

# Binaries will be in target/release/:
# - claude-inject (orchestration CLI)
# - cclaude-rs (interactive launcher)
```

### 2. Create Aliases (Optional)

```bash
# Add to ~/.bashrc
echo 'alias claude-inject="/home/daihu/__projects__/4genthub/claude-automation/rust-injector/target/release/claude-inject"' >> ~/.bashrc
echo 'alias cclaude="/home/daihu/__projects__/4genthub/claude-automation/rust-injector/target/release/cclaude-rs"' >> ~/.bashrc

# Reload
source ~/.bashrc
```

### 3. Verify Installation

```bash
# Test orchestration CLI
claude-inject --help

# Test interactive launcher
cclaude --help

# Check tmux
tmux -V
```

## üìö Documentation Map

| Document | Purpose | Audience |
|----------|---------|----------|
| **SYSTEM-OVERVIEW.md** (this file) | Complete system architecture | Everyone |
| **QUICK-START.md** | Quick start guide | New users |
| **CCLAUDE-LAUNCHER.md** | cclaude-rs detailed docs | Interactive users |
| **ORCHESTRATION-CLI.md** | Complete CLI reference | Automation users |
| **ARCHITECTURE.md** | Technical deep dive | Developers |
| **README.md** | Project overview | GitHub visitors |
| **SESSION-MAPPING.md** | PTY injection explanation | Technical readers |

## üéì Key Concepts

### 1. Agent Types

Agents are specialized AI roles loaded via MCP:
- `master-orchestrator-agent` - Coordinates work
- `coding-agent` - Writes code
- `test-orchestrator-agent` - Manages testing
- ... and 30+ more

**Loading Methods**:
- `spawn-worker`: Automatic via `mcp__agenthub_http__call_agent()`
- `cclaude-rs`: Via `CCLAUDE_AGENT` environment variable
- Hooks detect both methods automatically

### 2. Worker States

| State | Meaning | Next Actions |
|-------|---------|--------------|
| `starting` | Just spawned, initializing | Wait for ready |
| `ready` | Agent loaded, waiting for task | Send prompt |
| `working` | Processing task | Monitor or wait |
| `idle` | No current task | Assign new task or stop |
| `error` | Error occurred | Debug or restart |
| `stopped` | Worker terminated | Remove from registry |

### 3. Message Injection

**How it Works**:
1. Worker spawned in tmux with `--dangerously-skip-permissions`
2. tmux session is detached (runs in background)
3. `tmux send-keys` injects text into session
4. `-l` flag treats text as literal (not key commands)
5. Separate `Enter` key press submits the message

**Limitations**:
- Only works with tmux sessions (not regular terminals)
- Cannot inject into existing `cclaude` sessions
- TIOCSTI ioctl disabled in modern kernels

### 4. Registry Persistence

**Benefits**:
- Survives system restarts
- Track workers across sessions
- Query by agent type, status, or task ID
- Cleanup stopped workers automatically

**File Location**: `~/.claude-worker-registry.json`

**Manual Cleanup**:
```bash
# Remove all stopped workers
./target/release/claude-inject cleanup-registry

# Or manually edit/delete
rm ~/.claude-worker-registry.json
```

## üîç Troubleshooting

### Problem: Hooks not detecting agent

**Solution**: Verify `CCLAUDE_AGENT` is set:
```bash
echo $CCLAUDE_AGENT
```

Check hook logs:
```bash
cat ~/logs/claude-hooks/session_start_main.log
```

### Problem: Worker not responding to injection

**Solution**: Check tmux session exists:
```bash
tmux has-session -t worker-name && echo "Running" || echo "Stopped"
```

View session output:
```bash
tmux capture-pane -t worker-name -p | tail -20
```

### Problem: Registry out of sync

**Solution**: Cleanup and rebuild:
```bash
# Remove registry
rm ~/.claude-worker-registry.json

# Stop all tmux sessions
tmux kill-server

# Restart fresh
```

## üöß Future Enhancements

Potential improvements:
- [ ] WebSocket-based message injection (bypass TIOCSTI limitation)
- [ ] GUI for worker management
- [ ] cclaude-rs terminal spawning (like bash cclaude)
- [ ] Worker health checks and auto-restart
- [ ] Task queue system for workers
- [ ] Distributed worker support (multiple machines)

## üìù Summary

This system provides a **complete solution** for Claude orchestration:

‚úÖ **Background Automation**: spawn-worker with tmux for long-running tasks
‚úÖ **Interactive Development**: cclaude-rs for manual work
‚úÖ **Automatic Role Detection**: CCLAUDE_AGENT environment variable
‚úÖ **Worker Management**: Registry system with status tracking
‚úÖ **Message Injection**: tmux send-keys for dynamic communication
‚úÖ **Hook Integration**: Seamless agent type detection

**Choose the right tool**:
- Need background? ‚Üí `spawn-worker`
- Need interactive? ‚Üí `cclaude-rs`
- Need new terminal? ‚Üí `bash cclaude`
- Need all three? ‚Üí Use them together!
