# CLAUDE.md Agent Loading Clarification

## ğŸš¨ Critical Update

**Date**: 2025-11-16

**Issue**: Previous CLAUDE.md rules were confusing and contradictory about agent loading

## âŒ Old (Confusing) Rule

```
## CLOCK IN FIRST

### Default Agent: master-orchestrator-agent

Principal Sessions default to master-orchestrator-agent:
- Coordinates all work
- Manages task creation and delegation

Always call: mcp__agenthub_http__call_agent("master-orchestrator-agent")
```

**Problem**: This rule created confusion:
1. External launchers set CCLAUDE_AGENT=coding-agent
2. But rule says "always call master-orchestrator-agent first"
3. Claude confused: Should I ignore CCLAUDE_AGENT and call master-orchestrator-agent?
4. Result: Wrong agent loaded, user expectations violated

## âœ… New (Clear) Rule

```
## AGENT LOADING - CALL ON DEMAND

DO NOT automatically call master-orchestrator-agent!
Load the agent based on context:

Priority Order (check in this order):
1. CCLAUDE_AGENT environment variable (highest priority)
   - Hooks auto-load agent
   - You don't need to call anything

2. User-specified agent in conversation
   - User says: "act as coding-agent"
   - You call: mcp__agenthub_http__call_agent("coding-agent")

3. Task/context requires specific agent
   - Task needs coding â†’ call coding-agent

4. No agent specified (only then default)
   - Then and only then: Default to master-orchestrator-agent
```

**Benefits**:
- âœ… Clear priority order
- âœ… Respects CCLAUDE_AGENT from external launchers
- âœ… Calls agent on demand, not blindly
- âœ… master-orchestrator-agent only when nothing specified

## ğŸ“Š Decision Tree

```
Session Starts
     |
     v
Is CCLAUDE_AGENT set?
     |
     +-- YES â†’ Hooks auto-load agent
     |         â†“
     |         You don't call anything
     |         â†“
     |         You ARE that agent
     |
     +-- NO â†’ Did user specify agent?
               |
               +-- YES â†’ Call that agent
               |         â†“
               |         You ARE that agent
               |
               +-- NO â†’ Does task imply agent?
                         |
                         +-- YES â†’ Call implied agent
                         |         â†“
                         |         You ARE that agent
                         |
                         +-- NO â†’ Call master-orchestrator-agent
                                   â†“
                                   You ARE orchestrator
```

## ğŸ¯ Practical Examples

### Example 1: cclaude-rs Spawns coding-agent

```bash
# User runs:
cclaude-rs --agent coding-agent "implement auth"

# What happens:
1. cclaude-rs sets CCLAUDE_AGENT=coding-agent
2. Hooks detect CCLAUDE_AGENT
3. Hooks call: mcp__agenthub_http__call_agent("coding-agent")
4. Claude receives system_prompt for coding-agent
5. Claude acts as coding-agent (NOT master-orchestrator-agent!)

# Claude should:
âœ… Recognize: "I am coding-agent"
âœ… Use coding-agent tools and instructions
âŒ Don't call master-orchestrator-agent
âŒ Don't ignore CCLAUDE_AGENT
```

### Example 2: Manual Session, User Requests Agent

```bash
# User runs normal Claude (no CCLAUDE_AGENT)
claude

# User says:
"Act as test-orchestrator-agent and run all tests"

# Claude should:
1. âœ… Check CCLAUDE_AGENT â†’ Not set
2. âœ… Check user request â†’ User wants test-orchestrator-agent
3. âœ… Call: mcp__agenthub_http__call_agent("test-orchestrator-agent")
4. âœ… Become test-orchestrator-agent
5. âœ… Run tests as that agent

# Don't:
âŒ Call master-orchestrator-agent first
âŒ Ignore user's agent specification
```

### Example 3: Manual Session, No Agent Specified

```bash
# User runs normal Claude (no CCLAUDE_AGENT)
claude

# User says:
"Analyze this codebase"

# Claude should:
1. âœ… Check CCLAUDE_AGENT â†’ Not set
2. âœ… Check user request â†’ No specific agent mentioned
3. âœ… Check task context â†’ Analysis could be any agent
4. âœ… Default: Call master-orchestrator-agent
5. âœ… Coordinate work as orchestrator

# This is the ONLY case to default to master-orchestrator-agent
```

## ğŸ”‘ Key Principles

### 1. Respect External Launchers

When CCLAUDE_AGENT is set:
- âœ… **Trust it** - external launcher knows what it wants
- âœ… **Don't override** - hooks already loaded that agent
- âŒ **Don't call master-orchestrator-agent** - it's the wrong agent

### 2. Agent on Demand

- âœ… Call the agent **the user/task needs**
- âœ… Be context-aware
- âŒ Don't blindly call master-orchestrator-agent every time

### 3. Priority Hierarchy

```
1. CCLAUDE_AGENT (external launcher)  <-- Highest priority
2. User explicit request              <-- Second priority
3. Task context/inference             <-- Third priority
4. Default to master-orchestrator     <-- Last resort only
```

## ğŸ“ Updated CLAUDE.md Sections

### Section 1: AGENT LOADING - CALL ON DEMAND

**Lines**: 59-115

**Changes**:
- Renamed from "CLOCK IN FIRST"
- Added priority order (1-4)
- Emphasized CCLAUDE_AGENT as highest priority
- Added critical rules (âœ… Do / âŒ Don't)

### Section 2: AGENT-ON-DEMAND WORKFLOW

**Lines**: 16-59

**Changes**:
- Renamed from "MASTER ORCHESTRATOR COMPLETE WORKFLOW"
- Added agent specification check (steps 2a-2c)
- Shows decision tree for agent selection
- Removed assumption of master-orchestrator-agent by default

### Section 3: Workflow

**Lines**: 152-183

**Changes**:
- Added "Check for CCLAUDE_AGENT first"
- Shows two examples: external launcher vs manual session
- Clarified when to call vs when hooks handle it

## ğŸ“ Teaching Claude

### What Claude Should Learn

**Old Misconception**:
```
"I should always call master-orchestrator-agent first"
"It's the default for principal sessions"
```

**New Understanding**:
```
"I should check context before loading an agent:
 1. Is CCLAUDE_AGENT set? â†’ Hooks loaded it, I'm that agent
 2. Did user specify? â†’ Call what user wants
 3. Does task imply agent? â†’ Call appropriate agent
 4. Nothing specified? â†’ Then default to orchestrator"
```

## âœ… Testing the Changes

### Test 1: External Launcher

```bash
# Spawn with coding-agent
cclaude-rs --agent coding-agent "test"

# Expected Claude behavior:
âœ… Recognizes CCLAUDE_AGENT=coding-agent
âœ… Acts as coding-agent (not orchestrator)
âœ… Uses coding-agent tools and instructions
```

### Test 2: Manual with User Request

```bash
# Normal Claude session
claude

# User: "act as documentation-agent and update README"

# Expected Claude behavior:
âœ… Calls: mcp__agenthub_http__call_agent("documentation-agent")
âœ… Becomes documentation-agent
âœ… Updates README as doc agent
```

### Test 3: Manual with No Specification

```bash
# Normal Claude session
claude

# User: "help me with this project"

# Expected Claude behavior:
âœ… No CCLAUDE_AGENT detected
âœ… No specific agent requested
âœ… Defaults to master-orchestrator-agent
âœ… Acts as coordinator
```

## ğŸš¨ Common Mistakes to Avoid

### Mistake 1: Always Calling Master-Orchestrator

```
âŒ WRONG:
Every session start â†’ call master-orchestrator-agent
Ignore CCLAUDE_AGENT

âœ… RIGHT:
Check context first
Respect CCLAUDE_AGENT
Call appropriate agent
```

### Mistake 2: Ignoring CCLAUDE_AGENT

```
âŒ WRONG:
CCLAUDE_AGENT=coding-agent set
Claude calls master-orchestrator-agent anyway

âœ… RIGHT:
CCLAUDE_AGENT=coding-agent set
Hooks already loaded coding-agent
Claude acts as coding-agent
```

### Mistake 3: Defaulting Too Early

```
âŒ WRONG:
User says "implement feature"
Claude defaults to master-orchestrator-agent

âœ… RIGHT:
User says "implement feature"
Implementation = coding task
Claude calls coding-agent
```

## ğŸ“š Related Documentation

- **CLAUDE.md** - Updated with new agent loading rules
- **FIX-CCLAUDE-AGENT-ENV.md** - Environment variable propagation
- **CCLAUDE-LAUNCHER.md** - External launcher documentation
- **SYSTEM-OVERVIEW.md** - Complete system architecture

## ğŸ¯ Summary

**Old Rule**: "Always call master-orchestrator-agent first"
**Problem**: Conflicted with external launchers, created confusion
**New Rule**: "Call agent on demand based on priority order"
**Benefit**: Respects context, clear decision tree, no confusion

**Key Takeaway**: Claude should be **context-aware** and **respect specifications**, not blindly default to master-orchestrator-agent in every case.
